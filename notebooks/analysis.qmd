---
title: "Depression, Family Functionality and Glycemic Control - Analysis"
format: docx
table-of-contents: true
editor: visual
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo=FALSE, warning = FALSE, message = FALSE)
```


```{r import-libraries}
pacman::p_load(
  tidyverse, # Data manipulation and visualisation
  gtsummary, # Summary and regression tables
  finalfit, # Modelling
  rio, # Import data
  here, # File management
  skimr, # Skim dataset
  broom, # Tidy output
  car, # Variance inflation factor
  rstatix, # Pipe friendly statistical test
  GGally # Correlation matrix
)
```



# Introduction


```{r import-dataset}
# Import datasets
df <- import(here("data", "clean_data.RData"), trust = TRUE) # Full dataset
demographics <- import(here("data", "demos.RData"), trust = TRUE) # Demographics subset
depression <- import(here("data", "depression.RData"), trust = TRUE) # Depression subset
fam_func <- import(here("data", "family.RData"), trust = TRUE) # Family functionality
health <- import(here("data", "health.RData"), trust = TRUE) # Health characteristics 
```

```{r skim-data}
skim(df)
```

## Normality test

```{r shapiro-wilk-test}
# Create function
shapiro_test <- function(x) {
  shapiro_resut <- shapiro.test(x)
  return(shapiro_resut$p.value)
}

# Extract numeric variables
numeric_vars <- df |>
  select_if(is.numeric)

# Apply function to numeric variables
shapiro_p_values <- numeric_vars |>
  summarise(across(everything(), ~ shapiro_test(.))) |>
  pivot_longer(everything(), names_to = "Variable", values_to = "P values")

# Print shapiro_result
print(shapiro_p_values)
```

***

# Descriptive and Inferential statistics

```{r categorical_variables}
# Categorical variables
categorical_vars <- df |> 
  select_if(is.factor)

colnames(categorical_vars)
```

```{r eval=FALSE}
#  [1] "sex"                          "education"                    "marital_status"               "religious_background"         "employment_status"           
#  [6] "place_of_permanent_residence" "monthly_income"               "duration_diabetes_cat"        "treatment_diabetes"           "functionality_cat"           
# [11] "depression_cat"               "mar_stat_three"               "mar_stat_two"                 "religion_two"                 "bmi_cat
```

## Demographics

```{r factor-relevel-label}
# Factor relevel monthly income, label age and age groups
demographics <- demographics |>
  mutate(
    monthly_income = monthly_income |>
      fct_relevel(
     "Below 546",
     "From 546 to 999",
    "From 1000 to 1499",
    "From 1500 to 1999",
     "2000 and above") |>
      ff_label("Monthly income in Ghanaian cedis"),
     age = age |> ff_label("Age (years)"),
     age_group = age_group |> ff_label("Age groups")
  )

```

```{r descriptives}
# Demographics
demographics |>
  select(-c(id, depression_cat, functionality_cat, hbaic_cat, religion_two, mar_stat_two, mar_stat_three)) |>
  tbl_summary(
    missing_text = "Missing",
    sort = list(c(marital_status, religious_background,
                  employment_status, place_of_permanent_residence) ~ "frequency")
)|>
  bold_labels()
```

## Health characteristics

```{r mutate-health-variables}
health <- 
  health |>
  mutate(
    hba1c_value = hba1c_value |>
      ff_label("Glycated hemoglobin (HBA1C) (%)"),
    body_weight = body_weight |>
      ff_label("Body weight (kg)"),
    height = height |>
      ff_label("Height (m)"),
    bmi = bmi |>
      ff_label("Body mass index (BMI) (kg/m^2)"),
    waist_circumference = waist_circumference |>
      ff_label("Waist circumference (cm)"),
    hip_circumference = hip_circumference |>
      ff_label("Hip circumference (cm)"),
    sbp = sbp |>
      ff_label("Systolic blood pressure (mmHg)"),
    dbp = dbp |>
      ff_label("Diastolic blood pressure (mmHg)"),
    whr = whr |>
      ff_label("Waist-to-hip ratio (WHR)"),
    whtr = whtr |>
      ff_label("Waist-to-height ratio"),
    duration_diabetes_cat = duration_diabetes_cat |>
      fct_relevel(
        "Below 1 year",
        "1 year to below 5 years",
        "5 years to below 10 years",
        "10 years and above"
      ) |>
        ff_label("Duration of diabetes"),
      treatment_diabetes = treatment_diabetes |> 
        fct_recode(
          "Insulin" = "insulin"
        ) |>
          ff_label("Medical treatment of diabetes"),
      functionality_cat = functionality_cat |>
        ff_label("Family functionality")
  )
```

```{r health}
# Health data
health |>
  select(-c(id, sex, duration_diabetes)) |>
  tbl_summary(
    missing_text = "Missing",
    sort = list(c(treatment_diabetes) ~ "frequency"
  ) )|>
    bold_labels() |>
    add_ci(include=c("hbaic_cat", "functionality_cat", "depression_cat"))
  
```


## Demographics stratified by HBA1C


```{r demo-hbaic}
# Demographics by HBA1C outcome
demographics |>
  select(-c(id, depression_cat, functionality_cat, religion_two, mar_stat_two, mar_stat_three)) |>
  tbl_summary(by = hbaic_cat) |>
  add_p() |>
  bold_p() |>
  bold_labels()
```

## Health characteristics stratified by HBA1C outcome

```{r health-hbaic}
# Health characteristics by HBA1C outcome
health |>
  select(-c(id, sex, hba1c_value, duration_diabetes)) |>
  tbl_summary(by = hbaic_cat) |>
  add_p() |>
  bold_p() |>
  bold_labels()
```



# Logistic regression

## Multicolinearity

```{r}
# Convert categorical outcome variable to numeric (binary encoding)
df <- df |>
  mutate(
    hbaic_cat_binary = 
      ifelse(hbaic_cat == "Good control", 0, 1)
  )
```


```{r multi-co}
dependent_hb <- "hbaic_cat_binary"

explanatory <- c(
"sex",                        
"age",                       
"education",                   
"marital_status",              
"religious_background",        
"employment_status",           
"place_of_permanent_residence",
"monthly_income",              
"bmi",                     
"waist_circumference",         
"hip_circumference",   
"sbp",
"dbp",
"duration_diabetes_cat",
"treatment_diabetes" ,
"functionality_cat",
"depression_cat",
"whr",
"whtr"
)
```

## Multicollinearity: HBA1C

```{r vif-hbaic}
# Variance inflation factor for HBA1C outcome
df |>
  glmmulti(
    dependent_hb, explanatory
  ) |> car::vif()
```


## Correlation between numeric variables

```{r corr-numeric}
numeric_vars |>
  ggcorr(label=T)
```


## Univariate models: HBA1C


```{r hbaic-univariate}
# Vector of predictor variable names
predictors <- c(
  "sex", "age", "education", "marital_status", "religious_background",  "employment_status", "place_of_permanent_residence",
  "monthly_income", "sbp", "dbp", "duration_diabetes_cat", "treatment_diabetes", "bmi_cat", "bp_cat", "functionality_cat", "depression_cat"
)

# Fit one model per predictor, store in a named list
models <- lapply(predictors, function(var) {
  glm(reformulate(var, response = "hbaic_cat_binary"), data = df, family = binomial)
})
names(models) <- predictors
```

```{r univariate-table-hbaic}
# Sex model
th1 <- sex_model |>
  tbl_regression(
    exponentiate = TRUE
  ) |>
  bold_p() |>
  bold_labels()

# Age model
th2 <- age_model |> tbl_regression(
    exponentiate = TRUE
  ) |>
  bold_p() |>
  bold_labels()
  

# Educational status
th3 <- education_model |> tbl_regression(
    exponentiate = TRUE
  ) |>
  bold_p() |>
  bold_labels()

# Marital status
th4 <- marital_model |> tbl_regression(
    exponentiate = TRUE
  ) |>
  bold_p() |>
  bold_labels()

# Employment status
th6 <- employment_model|> tbl_regression(
    exponentiate = TRUE
  ) |>
  bold_p() |>
  bold_labels()

# Place of permanent residence
th7 <- permanent_model |> tbl_regression(
    exponentiate = TRUE
  ) |>
  bold_p() |>
  bold_labels()

# Monthly income
th8 <- income_model|> tbl_regression(
    exponentiate = TRUE
  ) |>
  bold_p() |>
  bold_labels()

# Waist circumference
th9 <- waist_model |> tbl_regression(
    exponentiate = TRUE
  ) |>
  bold_p() |>
  bold_labels()

# Hip circumference
th10 <- hip_model |> tbl_regression(
    exponentiate = TRUE
  ) |>
  bold_p() |>
  bold_labels()

# Systolic blood pressure
th11 <- sbp_model |> tbl_regression(
    exponentiate = TRUE
  ) |>
  bold_p() |>
  bold_labels()

# Diastolic blood pressure
th12 <- dbp_model |> tbl_regression(
    exponentiate = TRUE
  ) |>
  bold_p() |>
  bold_labels()

# Duration of diabetes
th13 <- duration_model |> tbl_regression(
    exponentiate = TRUE
  ) |>
  bold_p() |>
  bold_labels()

# Treatment of diabetes
th14 <- treatment_model |> tbl_regression(
    exponentiate = TRUE
  ) |>
  bold_p() |>
  bold_labels()

# BMI category
th15 <- bmi_model |> tbl_regression(
    exponentiate = TRUE
  ) |>
  bold_p() |>
  bold_labels()

# Blood pressure category
th16 <- bpcat_model |> tbl_regression(
    exponentiate = TRUE
  ) |>
  bold_p() |>
  bold_labels()

# Age group model
th17 <- age_gmodel |> tbl_regression(
    exponentiate = TRUE
  ) |>
  bold_p() |>
  bold_labels()

# Marital two model
th18 <- marital_two_model |> tbl_regression(
    exponentiate = TRUE
  ) |>
  bold_p() |>
  bold_labels()

# Marital three model
th19 <- marital_three_model |> tbl_regression(
    exponentiate = TRUE
  ) |>
  bold_p() |>
  bold_labels()

# Religious two model
th20 <- religion_two_model |> tbl_regression(
    exponentiate = TRUE
  ) |>
  bold_p() |>
  bold_labels()

uni_th <- tbl_stack(list(th1, th2, th3, th4, th6, th7, th8, th9, th10, th11, th12, th13, th14, th15, th16, th17, th18, th19, th20))

uni_th
```

### Multiple logisitic: HBA1C

```{r full-model-hbaic}
# full_model <- glm(hbaic_cat_binary ~ sex + age + education +
#                      marital_status +
#                      religious_background +
#                      employment_status +
#                      place_of_permanent_residence +
#                      monthly_income +
#                      sbp +
#                      dbp +
#                      waist_circumference +
#                      hip_circumference +
#                      duration_diabetes +
#                      treatment_diabetes,
#                    data = df,
#                    family = binomial
#                      )

full_model <- glm(hbaic_cat_binary ~ age + bp_cat + bmi_cat +
                     duration_diabetes + age_group,
                   data = df,
                   family = binomial
                     )

full_th <- full_model |>
  tbl_regression(
    exponentiate = TRUE
  ) |> bold_p() |>
  bold_labels()

full_th
```



```{r final-model-step}
final_model_th <- full_model|>
  step(direction = "forward", trace = FALSE)

final_model_th |>
  tbl_regression(
    exponentiate = TRUE
  ) |> bold_p() |>
  bold_labels()

final_model_th
```


```{r combine-uni-multi-hbaic}
# Combine univariate and multiple logistic regression tables
tbl_merge(list(uni_th, full_th), tab_spanner = c(
  "**Univariate regression**", "**Multivariable regression**"
))
```

## Model selection: HBA1C

```{r model-selection-hbaic, eval=FALSE, echo=FALSE, warning=FALSE, message=FALSE}
#| message: false
#| warning: false
explanatory_multi_h <- c(
"age",
"bp_cat",
"bmi_cat",
"duration_diabetes"
)

# "bp_cat",           
# "duration_diabetes",
# "bmi_cat"
df |>
  finalfit.glm(dependent=dependent_hb, explanatory, explanatory_multi_h, keep_models = TRUE, metrics = TRUE) 

```



